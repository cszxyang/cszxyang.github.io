<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <title>
       MyBatis 源码 - Mapper 的动态代理实现过程 &middot;  cszxyang
    </title>

    
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta property="og:title" content=" MyBatis 源码 - Mapper 的动态代理实现过程 &middot;  cszxyang" />
  	<meta property="og:site_name" content="cszxyang" />
  	<meta property="og:url" content="https://golb.cc/blog/2021/11/08/mybatis-%E6%BA%90%E7%A0%81-mapper-%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/" />

    
  	<meta property="og:type" content="article" />
    <meta property="og:article:published_time" content="2021-11-08T10:54:24&#43;02:00" />
    
    <meta property="og:article:tag" content="技术" />
    
    <meta property="og:article:tag" content="Java" />
    
    <meta property="og:article:tag" content="MyBatis源码" />
    
    <meta property="og:article:tag" content="源码" />
    
    

    <meta name="description" content="一路同步，静心记录。" />
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="https://golb.cc/images/favicon.ico">
	  <link rel="apple-touch-icon" href="https://golb.cc/images/apple-touch-icon.png" />
    <link rel="stylesheet" type="text/css" href="https://golb.cc/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="https://golb.cc/css/nav.css" />
    <link rel="stylesheet" type="text/css" href="https://golb.cc/css/hugo.css" />

    
    <link rel="stylesheet" type="text/css" href="https://golb.cc/css/highlight.css">
    <link rel="stylesheet" type="text/css" href="https://golb.cc/css/atom-one-dark.css">
    
    
    <script src="https://golb.cc/js/highlight.js"></script>
    <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
   
    
   <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?8ee45840325e1a8c8d1bdc689ea4d279";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
   </script>


    
    

    

    <link rel="canonical" href="https://golb.cc/blog/2021/11/08/mybatis-%E6%BA%90%E7%A0%81-mapper-%E7%9A%84%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E5%AE%9E%E7%8E%B0%E8%BF%87%E7%A8%8B/" />

    
</head>
<body class="nav-closed">

  <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        

        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://golb.cc/">首页</a>
            </li>
        
            
            <li class="nav-opened" role="presentation">
            	<a href="https://golb.cc/about">关于</a>
            </li>
        

        <li class="nav-opened" role="presentation"><a href=""></a></li>
        <li class="nav-opened" role="presentation"><a href="https://golb.cc/tags/技术/">技术</a></li>
        <li class="nav-opened" role="presentation"><a href="https://golb.cc/tags/生活/">生活</a></li>
        <li class="nav-opened" role="presentation"><a href="https://golb.cc/tags/随想/">随想</a></li>
        <li class="nav-opened" role="presentation"><a href="https://golb.cc/tags/翻译/">翻译</a></li>
        <li class="nav-opened" role="presentation"><a href="https://golb.cc/tags/笔记/">笔记</a></li>
    </ul>

    
    

    
</div>
<span class="nav-cover"></span>


 <div class="site-wrapper">




  <header class="main-header post-head" style="background-image: url(https://www.bing.com/ImageResolution.aspx?w=1366&amp;h=768)">
  

    <nav class="main-nav overlay clearfix">
    
        
    
    
        <a class="menu-button" href="#"><span class="burger">&#9776;</span><span class="word">菜单</span></a>
    
</nav>

    <div class="vertical">
        <div class="main-header-content inner">
            <h1 class="page-title">MyBatis 源码 - Mapper 的动态代理实现过程</h1>
            <h2 class="page-description">cszxyang</h2> <br/>
            
    <a class="bloglogo" href="https://github.com/cszxyang" target="_blank">
    <span class="icon-github" style="color:white;font-size:2em"></span>
    </a>
&nbsp;






        </div>
    </div>
</header>



<main class="content" role="main">
  <article class="post post">

    <header class="post-header">
        <h1 class="post-title">MyBatis 源码 - Mapper 的动态代理实现过程</h1>
        

        <section class="post-meta">
        
          <span class="post-tag small"><a href="https://golb.cc/tags/%E6%8A%80%E6%9C%AF/">#技术</a>&nbsp;&nbsp;&nbsp;&nbsp;</span>
        
          <span class="post-tag small"><a href="https://golb.cc/tags/java/">#Java</a>&nbsp;&nbsp;&nbsp;&nbsp;</span>
        
          <span class="post-tag small"><a href="https://golb.cc/tags/mybatis%E6%BA%90%E7%A0%81/">#MyBatis源码</a>&nbsp;&nbsp;&nbsp;&nbsp;</span>
        
          <span class="post-tag small"><a href="https://golb.cc/tags/%E6%BA%90%E7%A0%81/">#源码</a>&nbsp;&nbsp;&nbsp;&nbsp;</span>
        
        &nbsp;&nbsp;
        
          <time class="post-date" datetime="2021-11-08T10:54:24&#43;02:00">
            2021/11/8
          </time>
        
        </section>
        <br/>
    </header>

    <section class="post-content">
      <p>本文通过源码分析了解 MyBatis 的 Mapper 动态代理的实现原理。</p>
<p>在使用 Mabatis 时往往需要有成对出现的 <code>.java</code> 后缀格式 Mapper 接口文件及 <code>.xml</code> 后缀格式的 XML 文件，其中 XML 文件放在资源目录，而 Java 文件自然挡在运行目录，通过调用 Mapper 接口中定义的方法就能触发到其通过 namespace 关联的 XML 文件中的 SQL 语句，从而实现了业务逻辑与数据库交互的解耦，避免像传统 JDBC 编程那样在 Java 代码中写 SQL 与数据库交互，那么 Mybtis 是怎么将 Mapper 接口方法与 XML 中 SQL 语句进行绑定与触发的呢？下面我们通过测试方法 debug 调试进行进行代码跟踪。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProxyTest</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Logger logger <span style="color:#f92672">=</span> LoggerFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>ExecutorTest<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">private</span> Configuration configuration<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> Connection connection<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> JdbcTransaction jdbcTransaction<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> SqlSessionFactory sqlSessionFactory<span style="color:#f92672">;</span>

    <span style="color:#a6e22e">@Before</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SQLException <span style="color:#f92672">{</span>
        SqlSessionFactoryBuilder factoryBuilder <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SqlSessionFactoryBuilder<span style="color:#f92672">();</span>
        sqlSessionFactory <span style="color:#f92672">=</span> factoryBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">build</span><span style="color:#f92672">(</span>ExecutorTest<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResourceAsStream</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/mybatis/mybatis-config.xml&#34;</span><span style="color:#f92672">));</span>
        configuration <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">getConfiguration</span><span style="color:#f92672">();</span>
        connection <span style="color:#f92672">=</span> DriverManager<span style="color:#f92672">.</span><span style="color:#a6e22e">getConnection</span><span style="color:#f92672">(</span>JDBC<span style="color:#f92672">.</span><span style="color:#a6e22e">url</span><span style="color:#f92672">,</span> JDBC<span style="color:#f92672">.</span><span style="color:#a6e22e">username</span><span style="color:#f92672">,</span> JDBC<span style="color:#f92672">.</span><span style="color:#a6e22e">password</span><span style="color:#f92672">);</span>
        jdbcTransaction <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JdbcTransaction<span style="color:#f92672">(</span>connection<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#a6e22e">@Test</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">testProxy</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SQLException <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">try</span> <span style="color:#f92672">(</span>SqlSession sqlSession <span style="color:#f92672">=</span> sqlSessionFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">openSession</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
            UserMapper userMapper <span style="color:#f92672">=</span> sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">getMapper</span><span style="color:#f92672">(</span>UserMapper<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
            User user <span style="color:#f92672">=</span> userMapper<span style="color:#f92672">.</span><span style="color:#a6e22e">selectUser</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;User : &#34;</span> <span style="color:#f92672">+</span> user<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

</code></pre></div><h3 id="mapper-接口注册">Mapper 接口注册</h3>
<p>首先在 ProxyTest#init 方法中会触发 SqlSessionFactoryBuilder#build 方法进行配置文件解析，SqlSessionFactoryBuilder 顾名思义是 SqlSessionFactory 构造器，SqlSessionFactory 是生产 SqlSession 的工厂，SqlSessionFactoryBuilder 通过解析配置信息构造具体相应特性的 SqlSessionFactory，从而生产具有不同特性的 SqlSession 对象。按我理解，不同的特性，归根到底体现在 Configuration 对象的差异。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_17-41-31.png" alt="Snipaste_2021-11-07_17-41-31.png"></p>
<p>XMLConfigBuilder 的 parseConfiguration 方法会解析 XML 文件中的各种标签，其中包括 <code>mappers</code> 标签。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_17-50-13.png" alt="Snipaste_2021-11-07_17-50-13.png"></p>
<p>在 mapperElement 方法中会匹配 mapper 的配置方式，然后根据不同方式去读取 Mapper 的内容，</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_18-10-18.png" alt="Snipaste_2021-11-07_18-10-18.png"></p>
<p>由于我在 mavatis-config.xml 中以 resource 属性指定 mapper 的 XML 文件，所以上述代码会进入第一个 if 分支，以 resource 方式构造 XMLMapperBuilder 对象，然后进入 XMLMapperBuilder 的 parse 方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;mappers&gt;</span>
    <span style="color:#f92672">&lt;mapper</span> <span style="color:#a6e22e">resource=</span><span style="color:#e6db74">&#34;mybatis/UserMapper.xml&#34;</span><span style="color:#f92672">/&gt;</span>
    <span style="color:#f92672">&lt;mapper</span> <span style="color:#a6e22e">resource=</span><span style="color:#e6db74">&#34;mybatis/ContainerMapper.xml&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/mappers&gt;</span>
</code></pre></div><h3 id="xmlmapperbuilder-的-parse-方法">XMLMapperBuilder 的 parse 方法</h3>
<p>这个方法主要有关键的两步，第一步是解析 mapper 文件中的各个 SQL 相关的标签，最终整合成一个类似 <code>&lt;标签id，Statement&gt;</code> 之类的映射表，第二步是为Mapper 绑定代理工厂。</p>
<p>当触发 Mapper 方法时会通过 Mapper 的 Class 信息获取代理工厂并生成代理对象，这个代理对象中会缓存 mapper 方法与具体方法调用器的关系，类似  <code>&lt;method, invoker&gt;</code> 之类的映射，具体的触发逻辑交给相应的 invoker 实现，invoker 会使用到前面第一步中缓存的  <code>&lt;标签id，Statement&gt;</code> 的映射，拿到方法对应的 Statement 就能触发相应的 SQL 指令了。下面我们先看前两步。</p>
<h4 id="解析与配置-statement">解析与配置 Statement</h4>
<p>XMLMapperBuilder#configurationElement 方法解析 mapper 节点信息</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-09_15-29-44.png" alt="Snipaste_2021-11-09_15-29-44.png"></p>
<p>XMLMapperBuilder#configurationElement 方法中调用 XMLMapperBuilder#buildStatementFromContext 方法解析一个 mapper 文件中所有的 SQL 语句对应的节点，然后在复写方法中遍历节点集，然后为每个节点创建一个 XMLStatementBuilder 去解析其中的内容，得到一个对应的 MappedStatement 。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-09_15-31-28.png" alt="Snipaste_2021-11-09_15-31-28.png"></p>
<p>parseStatementNode 方法顾名思义就是解析一个 XML 语句标签的内容，得到一个 MappedStatement  对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">parseStatementNode</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    String id <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">);</span>
    String databaseId <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;databaseId&#34;</span><span style="color:#f92672">);</span>

    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span>databaseIdMatchesCurrent<span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> databaseId<span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">requiredDatabaseId</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
	<span style="color:#75715e">// select 或 delete 或 update 等
</span><span style="color:#75715e"></span>    String nodeName <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getNode</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getNodeName</span><span style="color:#f92672">();</span>
    <span style="color:#75715e">// SqlCommandType 枚举，对应 DML 类型
</span><span style="color:#75715e"></span>    SqlCommandType sqlCommandType <span style="color:#f92672">=</span> SqlCommandType<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>nodeName<span style="color:#f92672">.</span><span style="color:#a6e22e">toUpperCase</span><span style="color:#f92672">(</span>Locale<span style="color:#f92672">.</span><span style="color:#a6e22e">ENGLISH</span><span style="color:#f92672">));</span>
    <span style="color:#66d9ef">boolean</span> isSelect <span style="color:#f92672">=</span> sqlCommandType <span style="color:#f92672">==</span> SqlCommandType<span style="color:#f92672">.</span><span style="color:#a6e22e">SELECT</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">boolean</span> flushCache <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBooleanAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;flushCache&#34;</span><span style="color:#f92672">,</span> <span style="color:#f92672">!</span>isSelect<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">boolean</span> useCache <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBooleanAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;useCache&#34;</span><span style="color:#f92672">,</span> isSelect<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">boolean</span> resultOrdered <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBooleanAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;resultOrdered&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>

    <span style="color:#75715e">// Include Fragments before parsing
</span><span style="color:#75715e"></span>    XMLIncludeTransformer includeParser <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> XMLIncludeTransformer<span style="color:#f92672">(</span>configuration<span style="color:#f92672">,</span> builderAssistant<span style="color:#f92672">);</span>
    includeParser<span style="color:#f92672">.</span><span style="color:#a6e22e">applyIncludes</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getNode</span><span style="color:#f92672">());</span>

    String parameterType <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;parameterType&#34;</span><span style="color:#f92672">);</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> parameterTypeClass <span style="color:#f92672">=</span> resolveClass<span style="color:#f92672">(</span>parameterType<span style="color:#f92672">);</span>

    String lang <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;lang&#34;</span><span style="color:#f92672">);</span>
    LanguageDriver langDriver <span style="color:#f92672">=</span> getLanguageDriver<span style="color:#f92672">(</span>lang<span style="color:#f92672">);</span>

    <span style="color:#75715e">// Parse selectKey after includes and remove them.
</span><span style="color:#75715e"></span>    processSelectKeyNodes<span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> parameterTypeClass<span style="color:#f92672">,</span> langDriver<span style="color:#f92672">);</span>

    <span style="color:#75715e">// Parse the SQL (pre: &lt;selectKey&gt; and &lt;include&gt; were parsed and removed)
</span><span style="color:#75715e"></span>    KeyGenerator keyGenerator<span style="color:#f92672">;</span>
    String keyStatementId <span style="color:#f92672">=</span> id <span style="color:#f92672">+</span> SelectKeyGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">SELECT_KEY_SUFFIX</span><span style="color:#f92672">;</span>
    keyStatementId <span style="color:#f92672">=</span> builderAssistant<span style="color:#f92672">.</span><span style="color:#a6e22e">applyCurrentNamespace</span><span style="color:#f92672">(</span>keyStatementId<span style="color:#f92672">,</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">hasKeyGenerator</span><span style="color:#f92672">(</span>keyStatementId<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
        keyGenerator <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyGenerator</span><span style="color:#f92672">(</span>keyStatementId<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
        keyGenerator <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getBooleanAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;useGeneratedKeys&#34;</span><span style="color:#f92672">,</span>
                                                   configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">isUseGeneratedKeys</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> SqlCommandType<span style="color:#f92672">.</span><span style="color:#a6e22e">INSERT</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>sqlCommandType<span style="color:#f92672">))</span>
            <span style="color:#f92672">?</span> Jdbc3KeyGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span> <span style="color:#f92672">:</span> NoKeyGenerator<span style="color:#f92672">.</span><span style="color:#a6e22e">INSTANCE</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
	<span style="color:#75715e">// 解析具体的 SQL 语句
</span><span style="color:#75715e"></span>    SqlSource sqlSource <span style="color:#f92672">=</span> langDriver<span style="color:#f92672">.</span><span style="color:#a6e22e">createSqlSource</span><span style="color:#f92672">(</span>configuration<span style="color:#f92672">,</span> context<span style="color:#f92672">,</span> parameterTypeClass<span style="color:#f92672">);</span>
    StatementType statementType <span style="color:#f92672">=</span> StatementType<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;statementType&#34;</span><span style="color:#f92672">,</span> StatementType<span style="color:#f92672">.</span><span style="color:#a6e22e">PREPARED</span><span style="color:#f92672">.</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">()));</span>
    Integer fetchSize <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getIntAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fetchSize&#34;</span><span style="color:#f92672">);</span>
    Integer timeout <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getIntAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;timeout&#34;</span><span style="color:#f92672">);</span>
    String parameterMap <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;parameterMap&#34;</span><span style="color:#f92672">);</span>
    String resultType <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;resultType&#34;</span><span style="color:#f92672">);</span>
    Class<span style="color:#f92672">&lt;?&gt;</span> resultTypeClass <span style="color:#f92672">=</span> resolveClass<span style="color:#f92672">(</span>resultType<span style="color:#f92672">);</span>
    String resultMap <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;resultMap&#34;</span><span style="color:#f92672">);</span>
    String resultSetType <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;resultSetType&#34;</span><span style="color:#f92672">);</span>
    ResultSetType resultSetTypeEnum <span style="color:#f92672">=</span> resolveResultSetType<span style="color:#f92672">(</span>resultSetType<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resultSetTypeEnum <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        resultSetTypeEnum <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getDefaultResultSetType</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    String keyProperty <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;keyProperty&#34;</span><span style="color:#f92672">);</span>
    String keyColumn <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;keyColumn&#34;</span><span style="color:#f92672">);</span>
    String resultSets <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getStringAttribute</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;resultSets&#34;</span><span style="color:#f92672">);</span>
	<span style="color:#75715e">// 通过下面的参数构建 MappedStatement，并添加到 Configuration 的 mappedStatements 映射表中
</span><span style="color:#75715e"></span>    builderAssistant<span style="color:#f92672">.</span><span style="color:#a6e22e">addMappedStatement</span><span style="color:#f92672">(</span>id<span style="color:#f92672">,</span> sqlSource<span style="color:#f92672">,</span> statementType<span style="color:#f92672">,</span> sqlCommandType<span style="color:#f92672">,</span>
                                        fetchSize<span style="color:#f92672">,</span> timeout<span style="color:#f92672">,</span> parameterMap<span style="color:#f92672">,</span> parameterTypeClass<span style="color:#f92672">,</span> resultMap<span style="color:#f92672">,</span> resultTypeClass<span style="color:#f92672">,</span>
                                        resultSetTypeEnum<span style="color:#f92672">,</span> flushCache<span style="color:#f92672">,</span> useCache<span style="color:#f92672">,</span> resultOrdered<span style="color:#f92672">,</span>
                                        keyGenerator<span style="color:#f92672">,</span> keyProperty<span style="color:#f92672">,</span> keyColumn<span style="color:#f92672">,</span> databaseId<span style="color:#f92672">,</span> langDriver<span style="color:#f92672">,</span> resultSets<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>MapperBuilderAssistant#addMappedStatement 会将 MappedStatement 添加到 Configuration 的 mappedStatements 映射表中。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-11_16-07-10.png" alt="Snipaste_2021-11-11_16-07-10.png"></p>
<p>比如对于 UserMapper，其 XML 文件内容为</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34; ?&gt;</span>
<span style="color:#75715e">&lt;!DOCTYPE mapper
</span><span style="color:#75715e">        PUBLIC &#34;-//mybatis.org//DTD Mapper 3.0//EN&#34;
</span><span style="color:#75715e">        &#34;http://mybatis.org/dtd/mybatis-3-mapper.dtd&#34;&gt;</span>

<span style="color:#f92672">&lt;mapper</span> <span style="color:#a6e22e">namespace=</span><span style="color:#e6db74">&#34;com.github.cszxyang.ibatis.mapper.UserMapper&#34;</span><span style="color:#f92672">&gt;</span>
  <span style="color:#f92672">&lt;select</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;selectUser&#34;</span> <span style="color:#a6e22e">resultType=</span><span style="color:#e6db74">&#34;com.github.cszxyang.ibatis.model.User&#34;</span><span style="color:#f92672">&gt;</span>
    select * from user where id = #{id}
  <span style="color:#f92672">&lt;/select&gt;</span>

  <span style="color:#f92672">&lt;insert</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;addUser&#34;</span><span style="color:#f92672">&gt;</span>
    insert into user values (null, #{name}, #{age})
  <span style="color:#f92672">&lt;/insert&gt;</span>

  <span style="color:#f92672">&lt;update</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;updateByIdXml&#34;</span><span style="color:#f92672">&gt;</span>
    update user set name = #{name} where id = #{id}
  <span style="color:#f92672">&lt;/update&gt;</span>
<span style="color:#f92672">&lt;/mapper&gt;</span>
</code></pre></div><p>当处理完 selectUser 方法对应的标签后，得到的 Configuration 对象的 mappedStatement 信息为：</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-11_17-14-37.png" alt="Snipaste_2021-11-11_17-14-37.png"></p>
<p>UserMapper 接口如下，其中定义了一个注解标识 SQL 方法与三个绑定 XML 文件的方法</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">UserMapper</span> <span style="color:#f92672">{</span>
   <span style="color:#75715e">// @Select(&#34;select * from t_user where id = #{id}&#34;)
</span><span style="color:#75715e"></span>    User <span style="color:#a6e22e">selectUser</span><span style="color:#f92672">(</span>Integer id<span style="color:#f92672">);</span>
    
    <span style="color:#a6e22e">@Update</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;update user set name = #{name} where id = #{id}&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">updateById</span><span style="color:#f92672">(</span>Integer id<span style="color:#f92672">,</span> String name<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">updateByIdXml</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;id&#34;</span><span style="color:#f92672">)</span> Integer id<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">)</span> String name<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">addUser</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@Param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;name&#34;</span><span style="color:#f92672">)</span> String name<span style="color:#f92672">,</span> <span style="color:#a6e22e">@Param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;age&#34;</span><span style="color:#f92672">)</span> Integer age<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ContainerMapper 接口如下，其中定义了一个绑定 XML 文件的方法。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">ContainerMapper</span> <span style="color:#f92672">{</span>
    Container <span style="color:#a6e22e">listContainer</span><span style="color:#f92672">(</span>Integer id<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>当所有的 mapper 的 XML 都解析完的时候，得到的 Configuration 对象的 mappedStatement 信息为：</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-11_17-33-23.png" alt="Snipaste_2021-11-11_17-33-23.png"></p>
<p><strong>为什么一个方法有两个元素，分别为绝对形式与相对形式的，它们分别在哪个时机被使用？</strong></p>
<p>Configuration 的 mappedStatements  是自定义的 HashMap 的子类 StrictMap，在往其中添加 MappedStatement 时，如果是类似 <code>xxxMapper.xx</code> 形式的方法标签，会获取一个简短的名称，看这个简短方法名是否存在对应的 MappedStatement，如果没有则会为之添加一个键值对，当然原来长的方法名也会添加进去。所以就会看到上面的现象，一个方法名往往对应在 mappedStatements 会有两份。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-15_14-26-14.png" alt="Snipaste_2021-11-15_14-26-14.png"></p>
<p><strong>使用注解标识的 SQL 语句是在哪个时机被解析进 Configuration 的？</strong></p>
<p>见下面的 Mapper 接口注册流程。</p>
<h4 id="mapper-绑定">mapper 绑定</h4>
<p>执行完 XMLMapperBuilder#configurationElement 方法，然后进入 bindMapperForNamespace 方法</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_18-15-21.png" alt="Snipaste_2021-11-07_18-15-21.png"></p>
<p>XMLMapperBuilder#bindMapperForNamespace 方法如果没有判断到 Configuration 没有 mapper，会调用 Configuration 的 addMapper 方法往其中注册 Mapper 接口信息。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_18-19-46.png" alt="Snipaste_2021-11-07_18-19-46.png"></p>
<p>Configuration#addMapper 会调用 MapperRegistry#addMapper 方法，MapperRegistry  是 Configuration 维护的一个成员，按我理解是 “配置信息中的一部分，用于记录 mapper 注册信息”。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_18-20-46.png" alt="Snipaste_2021-11-07_18-20-46.png"></p>
<p>再看 MapperRegistry#addMapper 方法，入参是 Mapper 接口的 Class 信息，将它丢到其成员 <code>private final Map&lt;Class&lt;?&gt;, MapperProxyFactory&lt;?&gt;&gt; knownMappers = new HashMap&lt;&gt;();</code> 中，key 是 Class 对象引用，value 则是一个 MapperProxyFactory 对象，</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy//Snipaste_2021-11-07_18-23-08.png" alt="Snipaste_2021-11-07_18-23-08.png"></p>
<p>MapperProxyFactory 是所谓的代理对象生产工厂，其构造参数接收代理的接口的 Class 信息，然后需要创建代理对象时将调用 newInstance 方法。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_21-42-32.png" alt="Snipaste_2021-11-07_21-42-32.png"></p>
<h5 id="注解-sql-的解析">注解 SQL 的解析</h5>
<p>在 MapperAnnotationBuilder#parseStatement 方法中会处理 Mapper 中定义的每个方法，其中会调用 getAnnotationWrapper 方法判断这个方法上是否加有以下注解。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Set<span style="color:#f92672">&lt;</span>Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Annotation<span style="color:#f92672">&gt;&gt;</span> statementAnnotationTypes <span style="color:#f92672">=</span> Stream
      <span style="color:#f92672">.</span><span style="color:#a6e22e">of</span><span style="color:#f92672">(</span>Select<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Update<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Insert<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> Delete<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> SelectProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> UpdateProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span>
          InsertProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">,</span> DeleteProvider<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span>
      <span style="color:#f92672">.</span><span style="color:#a6e22e">collect</span><span style="color:#f92672">(</span>Collectors<span style="color:#f92672">.</span><span style="color:#a6e22e">toSet</span><span style="color:#f92672">());</span>
</code></pre></div><p>如果有注解的话就根据这个注解类型，解析出相应的 SQL 等信息，然后构建 MappedStatement 并添加到 Configuration 中。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-15_10-14-10.png" alt="Snipaste_2021-11-15_10-14-10.png"></p>
<p>再看下 getAnnotationWrapper 方法，入参是上述的 statementAnnotationTypes 注解集合，其中包含 8 个注解类型，</p>
<ul>
<li>
<p>遍历 statementAnnotationTypes，对于注解类型 x，有 <code>.flatMap(x -&gt; Arrays.stream(method.getAnnotationsByType(x)))</code> 一句，<code>method.getAnnotationsByType(x)</code> 用来获取当前处理方法上加了 x 类型的注解，或许这里可以加多个相同类型的注解，所以 getAnnotationsByType 方法返回的一个 Annotation 数组，所以使用 <code>Stream.of</code> 并压平，然后每个 Annotation  对象转化为 AnnotationWrapper 对象，然后以 databaseId 为维度进行分组。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-15_11-12-20.png" alt="Snipaste_2021-11-15_11-12-20.png"></p>
<p>由于 Mybatis 支持多数据源，对于每个 SQL 语句都可以指定去哪个数据源执行，所以 Update、Select 等这一堆注解中都可以指定 databaseId 属性，然后 AnnotationWrapper 封装时也会囊括这个字段。</p>
</li>
<li>
<p>获取当前配置的数据源的 databaseId 对应的 AnnotationWrapper。</p>
</li>
</ul>
<p><img src="https://golb.cc/assets/proxy/Snipaste_2021-11-15_10-21-56.png" alt="Snipaste_2021-11-15_10-21-56.png"></p>
<h3 id="mapper-代理对象的生成">Mapper 代理对象的生成</h3>
<p>跳进 SqlSession 的 getMapper 方法，</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_21-48-38.png" alt="Snipaste_2021-11-07_21-48-38.png"></p>
<p>SqlSession 是根据 Configuration 来创建的，所以它会持有一个 Configuration 对象</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_21-49-34.png" alt="Snipaste_2021-11-07_21-49-34.png"></p>
<p>然后由于 Mapper 的配置信息时放在 Configuration  的 MapperRegistry 里面的，所以需要调用 MapperRegistry#getMapper 方法获取 Mapper 代理对象。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_21-53-03.png" alt="Snipaste_2021-11-07_21-53-03.png"></p>
<p>然后通过 Mapper 接口的 Class 信息拿到相应的 MapperProxyFactory 对象，然后调用其 newInstance 方法创建代理对象。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_21-55-04.png" alt="img"></p>
<p>再回看 MapperProxyFactory#newInstance 方法，入参是 SqlSession 对象，根据 SqlSession  创建 MapperProxy 对象，然后通过 JDK 的动态代理技术创建 Mapper 接口的代理对象。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> T <span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>SqlSession sqlSession<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">final</span> MapperProxy<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> mapperProxy <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MapperProxy<span style="color:#f92672">&lt;&gt;(</span>sqlSession<span style="color:#f92672">,</span> mapperInterface<span style="color:#f92672">,</span> methodCache<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">return</span> newInstance<span style="color:#f92672">(</span>mapperProxy<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">protected</span> T <span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>MapperProxy<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> mapperProxy<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>T<span style="color:#f92672">)</span> Proxy<span style="color:#f92672">.</span><span style="color:#a6e22e">newProxyInstance</span><span style="color:#f92672">(</span>mapperInterface<span style="color:#f92672">.</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">(),</span> <span style="color:#66d9ef">new</span> Class<span style="color:#f92672">[]</span> <span style="color:#f92672">{</span> mapperInterface <span style="color:#f92672">},</span> mapperProxy<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>通过 debug 信息可见，最后生成的 Mapper 接口实现是 MapperProxy 对象。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-07_22-17-17.png" alt="Snipaste_2021-11-07_22-17-17.png"></p>
<h3 id="代理方法的触发">代理方法的触发</h3>
<p>调用 mapper 接口的 <code>selectUser</code> 方法，将触发代理类 MapperProxy 中实现自  InvocationHandler#invoke 方法。invoker 方法会根据方法信息去缓存中获取对应的方法调用器，如果获取不到就默认创建一个 PlainMethodInvoker 对象。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/cSnipaste_2021-11-08_22-27-51.png" alt="Snipaste_2021-11-08_22-27-51.png"></p>
<p>所以一般地 cachedInvoker 默认会返回一个 PlainMethodInvoker 对象，其中传入构造函数的参数是以 mapper 接口信息、触发的方法信息和 session 信息为参数构建的 MapperMethod 对象。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-08_22-30-15.png" alt="Snipaste_2021-11-08_22-30-15.png"></p>
<p>MapperMethod 构造时会初始化其 SqlCommand 和 MethodSignature 成员变量</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MapperMethod</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> SqlCommand command<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> MethodSignature method<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MapperMethod</span><span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;</span> mapperInterface<span style="color:#f92672">,</span> Method method<span style="color:#f92672">,</span> Configuration config<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">command</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SqlCommand<span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> mapperInterface<span style="color:#f92672">,</span> method<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">method</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MethodSignature<span style="color:#f92672">(</span>config<span style="color:#f92672">,</span> mapperInterface<span style="color:#f92672">,</span> method<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>下面是 SqlCommand 的构造函数，其 SqlCommandType 成员会记录对应 SQL 命令的类型，如 UNKNOWN, INSERT, UPDATE, DELETE, SELECT, FLUSH 等。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SqlCommand</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String name<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> SqlCommandType type<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">SqlCommand</span><span style="color:#f92672">(</span>Configuration configuration<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> mapperInterface<span style="color:#f92672">,</span> Method method<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">final</span> String methodName <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">final</span> Class<span style="color:#f92672">&lt;?&gt;</span> declaringClass <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getDeclaringClass</span><span style="color:#f92672">();</span>
        MappedStatement ms <span style="color:#f92672">=</span> resolveMappedStatement<span style="color:#f92672">(</span>mapperInterface<span style="color:#f92672">,</span> methodName<span style="color:#f92672">,</span> declaringClass<span style="color:#f92672">,</span>
                                                    configuration<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>ms <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">getAnnotation</span><span style="color:#f92672">(</span>Flush<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                name <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
                type <span style="color:#f92672">=</span> SqlCommandType<span style="color:#f92672">.</span><span style="color:#a6e22e">FLUSH</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BindingException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Invalid bound statement (not found): &#34;</span>
                                           <span style="color:#f92672">+</span> mapperInterface<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.&#34;</span> <span style="color:#f92672">+</span> methodName<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// 记录 MappedStatement 的 id，后续根据 id 获取到 Configuration 中的 MappedStatement
</span><span style="color:#75715e"></span>            name <span style="color:#f92672">=</span> ms<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">();</span>
            type <span style="color:#f92672">=</span> ms<span style="color:#f92672">.</span><span style="color:#a6e22e">getSqlCommandType</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>type <span style="color:#f92672">==</span> SqlCommandType<span style="color:#f92672">.</span><span style="color:#a6e22e">UNKNOWN</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BindingException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unknown execution method for: &#34;</span> <span style="color:#f92672">+</span> name<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>MethodSignature 用来维护 Mapper 方法对应的出入参等签名信息。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MethodSignature</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> returnsMany<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> returnsMap<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> returnsVoid<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> returnsCursor<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> returnsOptional<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Class<span style="color:#f92672">&lt;?&gt;</span> returnType<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> String mapKey<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Integer resultHandlerIndex<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> Integer rowBoundsIndex<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ParamNameResolver paramNameResolver<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">MethodSignature</span><span style="color:#f92672">(</span>Configuration configuration<span style="color:#f92672">,</span> Class<span style="color:#f92672">&lt;?&gt;</span> mapperInterface<span style="color:#f92672">,</span> Method method<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Type resolvedReturnType <span style="color:#f92672">=</span> TypeParameterResolver<span style="color:#f92672">.</span><span style="color:#a6e22e">resolveReturnType</span><span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> mapperInterface<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolvedReturnType <span style="color:#66d9ef">instanceof</span> Class<span style="color:#f92672">&lt;?&gt;)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;)</span> resolvedReturnType<span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>resolvedReturnType <span style="color:#66d9ef">instanceof</span> ParameterizedType<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Class<span style="color:#f92672">&lt;?&gt;)</span> <span style="color:#f92672">((</span>ParameterizedType<span style="color:#f92672">)</span> resolvedReturnType<span style="color:#f92672">).</span><span style="color:#a6e22e">getRawType</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span> <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">();</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnsVoid</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">void</span><span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnsMany</span> <span style="color:#f92672">=</span> configuration<span style="color:#f92672">.</span><span style="color:#a6e22e">getObjectFactory</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isCollection</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span><span style="color:#f92672">)</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isArray</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnsCursor</span> <span style="color:#f92672">=</span> Cursor<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnsOptional</span> <span style="color:#f92672">=</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnType</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mapKey</span> <span style="color:#f92672">=</span> getMapKey<span style="color:#f92672">(</span>method<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">returnsMap</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">mapKey</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">rowBoundsIndex</span> <span style="color:#f92672">=</span> getUniqueParamIndex<span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> RowBounds<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">resultHandlerIndex</span> <span style="color:#f92672">=</span> getUniqueParamIndex<span style="color:#f92672">(</span>method<span style="color:#f92672">,</span> ResultHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">paramNameResolver</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ParamNameResolver<span style="color:#f92672">(</span>configuration<span style="color:#f92672">,</span> method<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>再回到 MapperProxy#invoke 方法的逻辑，获取到 PlainMethodInvoker 对象后，会调用  PlainMethodInvoker#invoke 方法，实际上是 MapperMethod#execute 方法。</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-08_22-32-14.png" alt="Snipaste_2021-11-08_22-32-14.png"></p>
<h3 id="sql-指令执行">SQL 指令执行</h3>
<p>MapperMethod#execute 方法代码如下，先判断相应方法的 SQL 指令的类型，根据不同的 DML 指令类型执行不同的处理。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>SqlSession sqlSession<span style="color:#f92672">,</span> Object<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Object result<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">switch</span> <span style="color:#f92672">(</span>command<span style="color:#f92672">.</span><span style="color:#a6e22e">getType</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">case</span> INSERT<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            Object param <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">convertArgsToSqlCommandParam</span><span style="color:#f92672">(</span>args<span style="color:#f92672">);</span>
            result <span style="color:#f92672">=</span> rowCountResult<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">insert</span><span style="color:#f92672">(</span>command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> param<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">case</span> UPDATE<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            Object param <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">convertArgsToSqlCommandParam</span><span style="color:#f92672">(</span>args<span style="color:#f92672">);</span>
            result <span style="color:#f92672">=</span> rowCountResult<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> param<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">case</span> DELETE<span style="color:#f92672">:</span> <span style="color:#f92672">{</span>
            Object param <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">convertArgsToSqlCommandParam</span><span style="color:#f92672">(</span>args<span style="color:#f92672">);</span>
            result <span style="color:#f92672">=</span> rowCountResult<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">delete</span><span style="color:#f92672">(</span>command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> param<span style="color:#f92672">));</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">case</span> SELECT<span style="color:#f92672">:</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsVoid</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">hasResultHandler</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                executeWithResultHandler<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
                result <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsMany</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> executeForMany<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsMap</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> executeForMap<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsCursor</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
                result <span style="color:#f92672">=</span> executeForCursor<span style="color:#f92672">(</span>sqlSession<span style="color:#f92672">,</span> args<span style="color:#f92672">);</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
                Object param <span style="color:#f92672">=</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">convertArgsToSqlCommandParam</span><span style="color:#f92672">(</span>args<span style="color:#f92672">);</span>
                result <span style="color:#f92672">=</span> sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">selectOne</span><span style="color:#f92672">(</span>command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">(),</span> param<span style="color:#f92672">);</span>
                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsOptional</span><span style="color:#f92672">()</span>
                    <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>result<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">())))</span> <span style="color:#f92672">{</span>
                    result <span style="color:#f92672">=</span> Optional<span style="color:#f92672">.</span><span style="color:#a6e22e">ofNullable</span><span style="color:#f92672">(</span>result<span style="color:#f92672">);</span>
                <span style="color:#f92672">}</span>
            <span style="color:#f92672">}</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">case</span> FLUSH<span style="color:#f92672">:</span>
            result <span style="color:#f92672">=</span> sqlSession<span style="color:#f92672">.</span><span style="color:#a6e22e">flushStatements</span><span style="color:#f92672">();</span>
            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BindingException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Unknown execution method for: &#34;</span> <span style="color:#f92672">+</span> command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">().</span><span style="color:#a6e22e">isPrimitive</span><span style="color:#f92672">()</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>method<span style="color:#f92672">.</span><span style="color:#a6e22e">returnsVoid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BindingException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Mapper method &#39;&#34;</span> <span style="color:#f92672">+</span> command<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span>
                                   <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; attempted to return null from a method with a primitive return type (&#34;</span> <span style="color:#f92672">+</span> method<span style="color:#f92672">.</span><span style="color:#a6e22e">getReturnType</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;).&#34;</span><span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>以查询为例，SqlSession#selectOne 会调用 DefaultSqlSession#selectList 方法，其中会调用 Configuration#getMappedStatement 方法</p>
<p><img src="https://golb.cc/images/java/mybatis/proxy/Snipaste_2021-11-11_15-57-05.png" alt="Snipaste_2021-11-11_15-57-05.png"></p>
<p>Configuration#getMappedStatement 是根据 XML 标签中的 id 获取到具体的 statement，前面在 mapper 的 XML 的解析中介绍到 Mybatis 已经将 Mapper 中的信息读取到了 Configuration 里面了，所以这里能够直接拿到具体的配置在 XML 文件中的 SQL 语句，从而调用 JDBC 就能执行相应的指令</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> MappedStatement <span style="color:#a6e22e">getMappedStatement</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> validateIncompleteStatements<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>validateIncompleteStatements<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        buildAllStatements<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> mappedStatements<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div>
    </section>

    <footer class="post-footer">
      
        <figure class="author-image">
            <a class="img" href="https://golb.cc/" style="background-image: url(https://golb.cc/images/logo-cogi.gif)"><span class="hidden">cszxyang's Picture</span></a>
        </figure>
      

      





<section class="author" style="width:100%;">
  <div class="author-meta" style="width:100%;text-align:center;">
    <span class="author-location icon-user"> A shell picker</span>
    <span class="author-location icon-location"> Guangzhou, China</span>
    <span class="author-link icon-link"><a href="https://cszxyang.github.io/"> https://cszxyang.github.io/</a></span>
    

    
  </div>
  <br/>
</section>


      
        <aside class="read-next">
  

  
      <span class="readmore-next readmore-meta">NEXT: <a href="https://golb.cc/blog/2021/08/22/concurrenthashmap-1.7-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/"><h4>ConcurrentHashMap 1.7 源码分析</h4></a></span>
      
  
</aside>
<br/>

      
      
      

	
	<div id="lv-container" data-id="city" data-uid="MTAyMC81MDQ0OC8yNjkzNQ==">
		<script type="text/javascript">
	   (function(d, s) {
	       var j, e = d.getElementsByTagName(s)[0];

	       if (typeof LivereTower === 'function') { return; }

	       j = d.createElement(s);
	       j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
	       j.async = true;

	       e.parentNode.insertBefore(j, e);
	   })(document, 'script');
		</script>
	<noscript> 为正常使用来必力评论功能请激活JavaScript</noscript>
	</div>
	

	


    </footer>
</article>

</main>

    <footer class="site-footer clearfix">
        <a id="gotop" class="icon-arrow-up" href="#" title="back to top"></a>

        <section class="copyright"><a href="">cszxyang. </a> All rights reserved &copy; 2018 - 2020</section>
        
        <section class="poweredby">Proudly generated by <a href="http://gohugo.io">HUGO</a>, with <a class="icon-theme" href="https://github.com/vjeantet/hugo-theme-casper">Casper</a> theme &nbsp;
          <span id="cnzz_stat_icon_1000165127">
            <a href="https://tongji.baidu.com/web/10000135732/trend/latest?siteId=15190378" target="_blank" title="站长统计">
              <img border="0" hspace="0" vspace="0" src="http://icon.cnzz.com/img/pic1.gif">
            </a>
          </span>
        </section>
        
    </footer>
  </div> 
    <script type="text/javascript" src="https://golb.cc/js/jquery.js"></script>
    <script type="text/javascript" src="https://golb.cc/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://golb.cc/js/index.js"></script>

    
    
    
    

    
</body>
</html>

